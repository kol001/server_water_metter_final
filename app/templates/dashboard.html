{% extends "admin_base.html" %}
{% block title %}Tableau de bord – Niveaux d’eau{% endblock %}

{% block content %}
<!-- Row: 3 cartes -->
<div class="row g-4 mb-4">
  <div class="col-lg-3 col-md-6">
    <div class="card card-stat">
      <div class="card-body">
        <div class="card-stat__title">Réservoirs</div>
        <div class="card-stat__value" id="tankCount">—</div>
        <a href="#" class="card-stat__link">Voir les détails</a>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6">
    <div class="card card-stat">
      <div class="card-body">
        <div class="card-stat__title">Capteurs</div>
        <div class="card-stat__value">
          <span id="sensorCount">—</span>
          <small class="text-success">+1 aujourd’hui</small>
        </div>
        <a href="#" class="card-stat__link">Voir les détails</a>
      </div>
    </div>
  </div>

  <div class="col-lg-6 col-md-12">
    <div class="card cta-card">
      <div class="card-body">
        <div class="cta-card__text">
          Configurez rapidement un nouveau site de mesure (réservoir + capteurs) et démarrez le suivi en temps réel.
        </div>
        <a class="cta-card__action" href="#">Ajouter un site</a>
      </div>
    </div>
  </div>
</div>

<!-- Bloc graphique -->
<div class="card chart-card">
  <div class="card-header d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-droplet-fill"></i>
      <span>Niveau d’eau – 30 derniers jours</span>
    </div>
    <div>
      <select id="rangeSelect" class="form-select form-select-sm">
        <option value="30">30 jours</option>
        <option value="90">90 jours</option>
        <option value="180">6 mois</option>
      </select>
    </div>
  </div>

  <div class="card-body">
    <div class="d-flex align-items-baseline gap-2 mb-3">
      <div class="big-metric" id="avgThisPeriod">—</div>
      <div class="text-muted">cm (moyenne)</div>
    </div>

    <div style="height: 320px;">
      <canvas id="barChart"></canvas>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(async function initDashboard() {
  const token = localStorage.getItem('jwt_token');
  if (!token) return;

  // Valeurs par défaut
  let stats = { tanks: 0, sensors: 0 };

  try {
    const res = await fetch('/api/admin/stats', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    // Compatibilité avec anciens schémas: users/devices -> tanks/sensors
    stats.tanks   = json.tanks ?? json.reservoirs ?? json.users ?? 0;
    stats.sensors = json.sensors ?? json.devices ?? 0;
  } catch (e) {
    console.warn('Erreur /api/admin/stats :', e);
  }

  // Injecte les données
  document.getElementById('tankCount').textContent   = stats.tanks;
  document.getElementById('sensorCount').textContent = stats.sensors;

  // Démo pour la moyenne (en cm). Branche-la à ton API si tu l’as.
  const moyenneCm = 132.4;
  document.getElementById('avgThisPeriod').textContent =
    new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 1 }).format(moyenneCm);

  // Graphique : niveaux journaliers (cm) – données de démonstration
  const ctx = document.getElementById('barChart');
  const labels = ['01', '06', '11', '16', '21', '26']; // jours du mois
  const niveaux = [120, 118, 135, 142, 128, 150]; // en cm

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Niveau (cm)',
          data: niveaux,
          borderRadius: 10,
          backgroundColor: 'rgba(84, 104, 255, 0.85)',
          maxBarThickness: 40
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          suggestedMax: Math.max(...niveaux) + 20,
          grid: { color: '#f0f2f5' },
          ticks: { callback: v => v + ' cm' }
        },
        x: { grid: { display: false } }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: { label: (ctx) => ' ' + ctx.parsed.y + ' cm' }
        }
      }
    }
  });

  document.getElementById('rangeSelect').addEventListener('change', (e) => {
    // TODO: recharger les données selon la période (30/90/180 jours)
  });
})();
</script>
{% endblock %}
